<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="generator" content="nanoc 3.8.0">
    <link rel="icon" type="image/png" href="/favicon.png">

    <title>Inferical Writings - XcodeGhost: verify your Xcode</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/clean-blog.css" rel="stylesheet">
    <link href="/css/inferis.css" rel="stylesheet">
    <link href="/css/solarized-light.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <!-- jQuery -->
    <script src="/js/jquery.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Inferical Writings</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
              <li>
                  <a href="http://inferis.org">About</a>
              </li>
              <li>
                  <a href="/blog/archives/">Archives</a>
              </li>
              <li>
                  <a href="/blog/categories/">Categories</a>
              </li>
              <li>
                  <a href="/feed.atom"><i class="fa fa-rss-square" style="font-size: 200%; position: relative; top: -2px;"></i></a>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Page Header -->
<!-- Set your background image for this header on the line below. -->
<header class="intro-header" style="background-color: #eee;">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>
                      
                        XcodeGhost: verify your Xcode
                      
                    </h1>
                    

                    
                      <span class="meta">
                        
                        September 25, 2015 Â·
                        

                        <a href="/blog/2015/09/25/xcodeghost-verify-your-xcode/">âˆž</a>

                        
                        Â· 
                        
                      </span>
                    
                </div>
            </div>
        </div>
    </div>
</header>
<script type="text/javascript">

(function() {
    var d = new Date();
    var s = d.getSeconds() + "";
    var m = d.getMinutes() + "";
    var h = d.getHours() + "";

    if (s.length < 2) s = "0" + s;
    if (m.length < 2) m = "0" + m;
    if (h.length < 2) h = "0" + h;

    $(".intro-header").css("background-color", '#' + h + m + s);
})();

</script>


    <!-- Post Content -->
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

                  

<p>Recently a malware issue for the iOS app store (which is a rarity in itself) called <a href="http://www.macrumors.com/2015/09/20/xcodeghost-chinese-malware-faq/">XcodeGhost</a> made its appearances. I'm not going into the <a href="http://researchcenter.paloaltonetworks.com/2015/09/novel-malware-xcodeghost-modifies-xcode-infects-apple-ios-apps-and-hits-app-store/">gory</a> <a href="http://researchcenter.paloaltonetworks.com/2015/09/more-details-on-the-xcodeghost-malware-and-affected-ios-apps/">details</a>, but it boils down to a malware injection through a patched version of Xcode. When building iOS apps with such an Xcode, the app binary is modified transparently, injecting malwareware into your app at runtime. Nothing is downloaded from the internet, the malware just gets compiled into your app.</p>

<p>There's not a lot to do about this, except to make sure that you're using a legit Xcode. You can do this by never-ever downloading a version of Xcode from a location other than Apple's, which is either from the Mac App Store, or from <a href="http://developer.apple.com">http://developer.apple.com</a>) (I know this is easier said than done, saying this from my chair in the middle of super-connected Europe).</p>

<!-- more -->

<p>But, once you have an Xcode installed, it doesn't hurt to verify it's authenticity once in a while, especially if you use a build server to deliver your products.</p>

<p>In the <a href="https://developer.apple.com/news/?id=09222015a">communication</a> Apple released about XcodeGhost, they mention a simple tool to verify your Xcode. Fire up the command line and enter:</p>

<pre><code>spctl --assess --verbose /Applications/Xcode.app
</code></pre>

<p>The <code>spctl</code> command is a command that manages the security assessment policy subsystem of OSX, which is used to defince the system policy and code signing requirements.</p>

<p>If you get back a response which includes <code>accepted</code> (e.g. <code>/Applications/Xcode.app: accepted source=Mac App Store</code> or <code>/Applications/Xcode.app: accepted source=Apple</code>) you're in the safe zone and Xcode is not compromised. If you get back something else, the chance exists that your Xcode is compromised. It doesn't necessarily means that: if you accidentally edited a header file in the .app bundle, the assessment tool also notices this and will report an error. 
However, if you see a mention <code>CoreServices</code> passing by in the output of <code>spctl</code>, you're probably going to have a problem. By the way, the command can take a while so don't worry if it doesn't pony up an answer right away.</p>

<p>In any case, if you get an error it cannot hurt do download a fresh copy to be safe. Verify the downloaded app again, to make sure you updated it correctly.</p>

<h2>Jenkins</h2>

<p>Now, you don't want to be doing this manually on a regular basis, especially on a build server. At <a href="http://icapps.com">iCapps</a>, we have more than one Xcode on the server in order to support older projects (or until they are upgraded to newer versions of Xcode). So what we did was create a small shell script which fires off the <code>spctl</code> command which takes an Xcode.app path as an argument we have and have that script run each morning to verify all our versions. The script returns with a faulty exit code if the <code>spctl</code> output doesn't contain <code>accepted</code>, causing that job to fail. The failed job sends of an email to the development team so we get notified pretty quick in case something would go wrong.</p>

<p><img class="center" src="http://c.inferis.org/image/1x2M1L2u2O3J/Untitled-1.png"></p>

<p>The script itself is pretty simple, like I said:</p>

<pre><code class="language-sh highlight"><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"Validating '</span><span class="nv">$1</span><span class="s2">'. This can take a while."</span>
<span class="nv">OUTPUT</span><span class="o">=</span><span class="sb">`</span>spctl --assess --verbose <span class="nv">$1</span> 2&gt;&amp;1<span class="sb">`</span>

<span class="nb">echo</span> <span class="nv">$OUTPUT</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$OUTPUT</span> <span class="o">=</span>~ accepted <span class="o">]]</span>; <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"'</span><span class="nv">$1</span><span class="s2">' validates just fine."</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>;

<span class="nb">echo</span> <span class="s2">"'</span><span class="nv">$1</span><span class="s2">' does not validate."</span>
<span class="nb">exit </span>1</code></pre>

<p>Should be pretty obvious. There's one thing to point out: the <code>spctl</code> command outputs it's assessment on <em>stderr</em> so we need to pipe that output to <em>stdout</em> so that the backtick invocation can grab it. You do this by adding <code>2&gt;&amp;1</code> to your command invocation (standard error = file number 2, standard output = file number 1). If you don't do this, the script fails even though the command finds no error.</p>

<p>We added this script to a git repo, set up a jenkins job with that repo and had it run periodically:</p>

<p>Why use a repo and not install the script on the server directly? First of all it's a lot easier to keep track of and in case it needs changing you can do the changes locally, try them out and push to the repo. The server is updated automatically at the next validation job run.</p>

<p>And that job, all it does is invoke the script:</p>

<p><img class="center" src="http://c.inferis.org/image/0P2k3Z2S3c1Y/Image%202015-09-25%20at%203.58.29%20PM.png"></p>

<p>The parameter obviously changes for each Xcode install: just change the path to the Xcode.app you want to verify.</p>

<p>Like I said, we have this on a periodic schedule, on our case each morning:</p>

<p><img class="center" src="http://c.inferis.org/image/2P3E1K2W030w/Image%202015-09-25%20at%204.00.51%20PM.png"></p>

<p>But you could schedule this however you wanted, of course.</p>

<p>Finally, set up a post build email notification so that you actually get a warning when something goes south:</p>

<p><img class="center" src="http://c.inferis.org/image/2b2l1W432O07/Image%202015-09-25%20at%204.02.57%20PM.png"></p>

<p>And that's it. You're a bit safe now in this cruel, cruel world. Not entirely safe: if somebody gains access to your server away and messes with you Xcodes they'll probably find &amp; disable these jobs too. But this is better than nothing at all.</p>

<p>The best part: if you Do Things Right, this should never bother you. ðŸ˜‰</p>

<h2>Fastlane</h2>

<p>And oh, the fabulous <a href="http://fastlane.tools">Fastlane</a> toolchain by <a href="http://twitter.com/krausefx">Felix Krause</a> also provides a <code>verify</code> action that you can use in your Fastfiles, making sure that you verify the Xcode you're going to use for that build is valid. The build will take longer of course, but it's the price to pay for ensured security. So if you're using Fastlane and want to make sure your builds are "safe of malware" add this action to your Fastfile.</p>



                  

                </div>
            </div>
        </div>
    </article>

    <hr>

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="https://twitter.com/inferis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://instagram.com/inferis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/inferis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://facebook.com/inferis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="http://www.linkedin.com/in/tomadriaenssen">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://app.net/inferis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-adn fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://pinboard.in/u:inferis">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-thumb-tack fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">This blog is <a href="https://github.com/Inferis/inferis.github.io">open source</a>.</p>
            </div>
        </div>
    </div>
</footer>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  if (window.location.hostname != "localhost") {
    ga('create', 'UA-155493-9', 'auto');
    ga('send', 'pageview');
  }

</script>


</body>

</html>
